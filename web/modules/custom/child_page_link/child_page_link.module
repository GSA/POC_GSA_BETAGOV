<?php

use Drupal\node\NodeInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Link;
use Drupal\Core\Url;
use Drupal\node\Entity\NodeType;

/**
 * Implements hook_node_view().
 *
 * Adds custom links to the node view for adding child pages.
 */
function child_page_link_node_view(array &$build, NodeInterface $node, EntityViewDisplayInterface $display, $view_mode) {
  $config = \Drupal::config('child_page_link.settings')->get('types');
  $node_type = $node->bundle();

  // Check if the node type is enabled and if it has siblings configured
  if (!empty($config[$node_type]['enabled']) && !empty($config[$node_type]['siblings'])) {
    $links = [];
    foreach ($config[$node_type]['siblings'] as $sibling) {
      // Ensure sibling type is also enabled
      if (!empty($config[$sibling]['enabled'])) {
        $url = Url::fromRoute('node.add', ['node_type' => $sibling]);
        $sibling_type = NodeType::load($sibling);
        $link_text = t('Add @type', ['@type' => $sibling_type ? $sibling_type->label() : $sibling]);
        $links[] = Link::fromTextAndUrl($link_text, $url)->toString();
      }
    }
  }
}

